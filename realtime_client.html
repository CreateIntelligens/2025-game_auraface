<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraFace å³æ™‚äººè‡‰è­˜åˆ¥</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .video-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .video-section {
            flex: 1;
        }
        
        video, canvas {
            width: 100%;
            max-width: 640px;
            height: auto;
            border: 2px solid #ddd;
            border-radius: 5px;
        }
        
        .controls {
            margin: 10px 0;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status-connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .recognition-info {
            margin-top: 10px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 5px;
            font-family: monospace;
            font-size: 14px;
        }
        
        .register-form {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AuraFace å³æ™‚äººè‡‰è­˜åˆ¥ç³»çµ±</h1>
        
        <!-- é€£æ¥ç‹€æ…‹ -->
        <div id="connectionStatus" class="status status-disconnected">
            æœªé€£æ¥åˆ°ä¼ºæœå™¨
        </div>
        
        <!-- æ”åƒé ­æ§åˆ¶ -->
        <div class="controls">
            <button id="startCamera" class="btn-primary">å•Ÿå‹•æ”åƒé ­</button>
            <button id="stopCamera" class="btn-danger" disabled>åœæ­¢æ”åƒé ­</button>
            <button id="connectWS" class="btn-success">é€£æ¥WebSocket</button>
        </div>
        
        <!-- å½±åƒé¡¯ç¤ºå€åŸŸ -->
        <div class="video-container">
            <div class="video-section">
                <h3>æ”åƒé ­ç•«é¢</h3>
                <video id="videoElement" autoplay muted></video>
            </div>
            <div class="video-section">
                <h3>è­˜åˆ¥çµæœ</h3>
                <canvas id="resultCanvas"></canvas>
            </div>
        </div>
        
        <!-- è­˜åˆ¥è³‡è¨Š -->
        <div class="recognition-info" id="recognitionInfo">
            ç­‰å¾…è­˜åˆ¥çµæœ...
        </div>
    </div>
    
    <!-- çµ±è¨ˆè³‡æ–™ -->
    <div class="container">
        <h2>ğŸ“Š å³æ™‚çµ±è¨ˆ</h2>
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalFrames">0</div>
                <div>ç¸½è™•ç†å¹€æ•¸</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="facesDetected">0</div>
                <div>æª¢æ¸¬åˆ°äººè‡‰</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="employeesDetected">0</div>
                <div>å“¡å·¥è­˜åˆ¥</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="unknownDetected">0</div>
                <div>æœªçŸ¥äººå“¡</div>
            </div>
        </div>
    </div>
    
    <!-- è¨»å†Šæ–°äººè‡‰ -->
    <div class="container">
        <h2>ğŸ‘¤ è¨»å†Šæ–°äººè‡‰</h2>
        <div class="register-form">
            <div class="form-group">
                <label for="personName">å§“åï¼š</label>
                <input type="text" id="personName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label for="personRole">èº«åˆ†ï¼š</label>
                <select id="personRole">
                    <option value="å“¡å·¥">å“¡å·¥</option>
                    <option value="è¨ªå®¢">è¨ªå®¢</option>
                </select>
            </div>
            <div class="form-group">
                <label for="personDept">éƒ¨é–€ï¼š</label>
                <input type="text" id="personDept" placeholder="è«‹è¼¸å…¥éƒ¨é–€ï¼ˆå¯é¸ï¼‰">
            </div>
            <button id="captureRegister" class="btn-success">æ‹ç…§è¨»å†Š</button>
        </div>
    </div>

    <script>
        let videoStream = null;
        let websocket = null;
        let isStreaming = false;
        let frameInterval = null;
        
        const videoElement = document.getElementById('videoElement');
        const resultCanvas = document.getElementById('resultCanvas');
        const resultCtx = resultCanvas.getContext('2d');
        const connectionStatus = document.getElementById('connectionStatus');
        const recognitionInfo = document.getElementById('recognitionInfo');
        
        // WebSocket é€£æ¥
        function connectWebSocket() {
            try {
                websocket = new WebSocket('ws://localhost:8765');
                
                websocket.onopen = function(event) {
                    connectionStatus.textContent = 'å·²é€£æ¥åˆ°ä¼ºæœå™¨';
                    connectionStatus.className = 'status status-connected';
                };
                
                websocket.onmessage = function(event) {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                websocket.onclose = function(event) {
                    connectionStatus.textContent = 'èˆ‡ä¼ºæœå™¨æ–·ç·š';
                    connectionStatus.className = 'status status-disconnected';
                };
                
                websocket.onerror = function(error) {
                    console.error('WebSocket éŒ¯èª¤:', error);
                    connectionStatus.textContent = 'WebSocket é€£æ¥éŒ¯èª¤';
                    connectionStatus.className = 'status status-disconnected';
                };
            } catch (error) {
                console.error('ç„¡æ³•é€£æ¥ WebSocket:', error);
            }
        }
        
        // è™•ç† WebSocket è¨Šæ¯
        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'recognition_result':
                    displayRecognitionResult(data);
                    break;
                case 'stats':
                    updateStats(data.data);
                    break;
                case 'register_result':
                    alert(data.success ? 'è¨»å†ŠæˆåŠŸ: ' + data.message : 'è¨»å†Šå¤±æ•—: ' + data.message);
                    break;
                case 'error':
                    console.error('ä¼ºæœå™¨éŒ¯èª¤:', data.message);
                    break;
            }
        }
        
        // é¡¯ç¤ºè­˜åˆ¥çµæœ
        function displayRecognitionResult(data) {
            // æ›´æ–°è­˜åˆ¥è³‡è¨Š
            const info = `
FPS: ${data.fps} | è™•ç†æ™‚é–“: ${data.processing_time}ms
æª¢æ¸¬åˆ° ${data.faces.length} å¼µäººè‡‰
${data.faces.map(face => 
    `${face.name} (${face.role}) - ä¿¡å¿ƒåº¦: ${face.confidence.toFixed(3)}`
).join('\\n')}
æ™‚é–“: ${new Date(data.timestamp).toLocaleTimeString()}
            `;
            recognitionInfo.textContent = info;
            
            // é¡¯ç¤ºè™•ç†å¾Œçš„åœ–ç‰‡
            const img = new Image();
            img.onload = function() {
                resultCanvas.width = img.width;
                resultCanvas.height = img.height;
                resultCtx.drawImage(img, 0, 0);
            };
            img.src = data.image;
        }
        
        // æ›´æ–°çµ±è¨ˆè³‡æ–™
        function updateStats(stats) {
            document.getElementById('totalFrames').textContent = stats.total_frames;
            document.getElementById('facesDetected').textContent = stats.faces_detected;
            document.getElementById('employeesDetected').textContent = stats.employees_detected;
            document.getElementById('unknownDetected').textContent = stats.unknown_detected;
        }
        
        // å•Ÿå‹•æ”åƒé ­
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: 640, height: 480 }
                });
                videoElement.srcObject = videoStream;
                
                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                
                // é–‹å§‹å‚³é€å½±åƒå¹€
                startStreaming();
            } catch (error) {
                alert('ç„¡æ³•å­˜å–æ”åƒé ­: ' + error.message);
            }
        }
        
        // åœæ­¢æ”åƒé ­
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoElement.srcObject = null;
            }
            
            document.getElementById('startCamera').disabled = false;
            document.getElementById('stopCamera').disabled = true;
            
            // åœæ­¢å‚³é€
            stopStreaming();
        }
        
        // é–‹å§‹ä¸²æµ
        function startStreaming() {
            if (isStreaming || !websocket || websocket.readyState !== WebSocket.OPEN) {
                return;
            }
            
            isStreaming = true;
            
            // æ¯ç§’å‚³é€ 10 å¹€
            frameInterval = setInterval(() => {
                if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                    sendVideoFrame();
                }
            }, 100); // 100ms = 10 FPS
        }
        
        // åœæ­¢ä¸²æµ
        function stopStreaming() {
            isStreaming = false;
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
            }
        }
        
        // å‚³é€å½±åƒå¹€
        function sendVideoFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.8);
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'video_frame',
                    image: imageData
                }));
            }
        }
        
        // æ‹ç…§è¨»å†Š
        function captureForRegistration() {
            const name = document.getElementById('personName').value;
            const role = document.getElementById('personRole').value;
            const dept = document.getElementById('personDept').value;
            
            if (!name) {
                alert('è«‹è¼¸å…¥å§“å');
                return;
            }
            
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'register_face',
                    name: name,
                    role: role,
                    department: dept,
                    image: imageData
                }));
                
                // æ¸…ç©ºè¡¨å–®
                document.getElementById('personName').value = '';
                document.getElementById('personDept').value = '';
            } else {
                alert('è«‹å…ˆé€£æ¥ WebSocket');
            }
        }
        
        // å®šæœŸè«‹æ±‚çµ±è¨ˆè³‡æ–™
        function requestStats() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'get_stats' }));
            }
        }
        
        // äº‹ä»¶ç›£è½å™¨
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);
        document.getElementById('connectWS').addEventListener('click', connectWebSocket);
        document.getElementById('captureRegister').addEventListener('click', captureForRegistration);
        
        // å®šæœŸæ›´æ–°çµ±è¨ˆ
        setInterval(requestStats, 5000); // æ¯ 5 ç§’æ›´æ–°çµ±è¨ˆ
        
        // é é¢è¼‰å…¥æ™‚è‡ªå‹•é€£æ¥
        window.addEventListener('load', function() {
            setTimeout(connectWebSocket, 1000);
        });
    </script>
</body>
</html>