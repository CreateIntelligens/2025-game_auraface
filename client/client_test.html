<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraFace WebSocket æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .processing { background-color: #fff3cd; color: #856404; }
        
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; }
        
        #fileInput {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #ddd;
            border-radius: 5px;
        }
        
        #results {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .face-result {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            border-left: 4px solid #ddd;
        }
        .face-unknown { border-left-color: #dc3545; }
        .face-employee { border-left-color: #28a745; }
        .face-visitor { border-left-color: #ffc107; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” AuraFace WebSocket æ¸¬è©¦</h1>
        
        <div id="status" class="status disconnected">
            âŒ æœªé€£æ¥åˆ° WebSocket æœå‹™å™¨
        </div>
        
        <div>
            <button id="connectBtn" onclick="connect()">é€£æ¥ WebSocket</button>
            <button id="disconnectBtn" onclick="disconnect()" disabled>æ–·é–‹é€£æ¥</button>
        </div>
        
        <div>
            <h3>ğŸ“· ä¸Šå‚³åœ–ç‰‡æ¸¬è©¦</h3>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(event)">
            <button id="testBtn" onclick="sendTestImage()" disabled>ç™¼é€æ¸¬è©¦åœ–ç‰‡</button>
        </div>
        
        <div>
            <h3>ğŸ“Š æœå‹™çµ±è¨ˆ</h3>
            <button id="statsBtn" onclick="getStats()" disabled>ç²å–çµ±è¨ˆ</button>
        </div>
        
        <div id="results">ç­‰å¾…æ¸¬è©¦çµæœ...</div>
    </div>

    <script>
        let ws = null;
        let currentImageData = null;
        
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = 'status ' + type;
        }
        
        function updateButtons(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('testBtn').disabled = !connected || !currentImageData;
            document.getElementById('statsBtn').disabled = !connected;
        }
        
        function connect() {
            try {
                updateStatus('â³ æ­£åœ¨é€£æ¥...', 'processing');
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = function(event) {
                    updateStatus('âœ… å·²é€£æ¥åˆ° WebSocket æœå‹™å™¨', 'connected');
                    updateButtons(true);
                    addResult('ğŸ“¡ WebSocket é€£æ¥å»ºç«‹æˆåŠŸ');
                };
                
                ws.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleMessage(data);
                        updateStatus('âœ… å·²é€£æ¥åˆ° WebSocket æœå‹™å™¨', 'connected');
                    } catch (e) {
                        addResult('âŒ è§£ææ¶ˆæ¯éŒ¯èª¤: ' + e);
                    }
                };
                
                ws.onclose = function(event) {
                    updateStatus('âŒ WebSocket é€£æ¥å·²æ–·é–‹ (ä»£ç¢¼: ' + event.code + ')', 'disconnected');
                    updateButtons(false);
                    addResult('ğŸ“¡ WebSocket é€£æ¥æ–·é–‹ - ä»£ç¢¼: ' + event.code + ', åŸå› : ' + (event.reason || 'æœªçŸ¥'));
                };
                
                ws.onerror = function(error) {
                    updateStatus('âŒ WebSocket é€£æ¥éŒ¯èª¤', 'disconnected');
                    addResult('âŒ é€£æ¥éŒ¯èª¤: ' + error);
                    console.error('WebSocket éŒ¯èª¤:', error);
                };
                
            } catch (error) {
                updateStatus('âŒ ç„¡æ³•é€£æ¥åˆ° WebSocket', 'disconnected');
                addResult('âŒ é€£æ¥å¤±æ•—: ' + error);
            }
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function handleMessage(data) {
            switch(data.type) {
                case 'connection_status':
                    addResult('ğŸ“¨ æœå‹™å™¨æ¶ˆæ¯: ' + data.message);
                    break;
                    
                case 'recognition_result':
                    handleRecognitionResult(data);
                    break;
                    
                case 'stats':
                    handleStats(data.data);
                    break;
                    
                default:
                    addResult('ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(data, null, 2));
            }
        }
        
        function handleRecognitionResult(data) {
            addResult('ğŸ¯ è­˜åˆ¥çµæœ:');
            addResult('   è™•ç†æ™‚é–“: ' + data.processing_time + ' ms');
            addResult('   FPS: ' + data.fps);
            addResult('   æª¢æ¸¬åˆ° ' + data.faces.length + ' å¼µäººè‡‰:');
            
            const resultsDiv = document.getElementById('results');
            
            data.faces.forEach((face, index) => {
                const faceDiv = document.createElement('div');
                faceDiv.className = 'face-result';
                
                if (face.person_id === 'unknown') {
                    faceDiv.classList.add('face-unknown');
                    faceDiv.innerHTML = `
                        <strong>äººè‡‰ ${index + 1}: ğŸ”´ æœªè­˜åˆ¥</strong><br>
                        person_id: "${face.person_id}"<br>
                        name: "${face.name}"<br>
                        role: "${face.role}"<br>
                        confidence: ${face.confidence.toFixed(3)}<br>
                        <em>é¡¯ç¤ºæ•ˆæœ: ç´…æ¡†ï¼Œç„¡æ–‡å­—æ¨™ç±¤</em>
                    `;
                } else {
                    const colorClass = face.role === 'å“¡å·¥' ? 'face-employee' : 'face-visitor';
                    const colorEmoji = face.role === 'å“¡å·¥' ? 'ğŸŸ¢' : 'ğŸŸ¡';
                    faceDiv.classList.add(colorClass);
                    faceDiv.innerHTML = `
                        <strong>äººè‡‰ ${index + 1}: ${colorEmoji} å·²è­˜åˆ¥</strong><br>
                        person_id: "${face.person_id}"<br>
                        name: "${face.name}"<br>
                        role: "${face.role}"<br>
                        confidence: ${face.confidence.toFixed(3)}<br>
                        <em>é¡¯ç¤ºæ•ˆæœ: ${face.role === 'å“¡å·¥' ? 'ç¶ ' : 'é»ƒ'}æ¡† + [${face.role === 'å“¡å·¥' ? 'Staff' : 'Visitor'}] ${face.name} ${face.confidence.toFixed(2)}</em>
                    `;
                }
                
                resultsDiv.appendChild(faceDiv);
            });
            
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function handleStats(stats) {
            addResult('ğŸ“Š æœå‹™çµ±è¨ˆ:');
            addResult('   ç¸½å¹€æ•¸: ' + stats.total_frames);
            addResult('   æª¢æ¸¬åˆ°äººè‡‰: ' + stats.faces_detected);
            addResult('   å“¡å·¥: ' + stats.employees_detected);
            addResult('   è¨ªå®¢: ' + stats.visitors_detected);
            addResult('   æœªçŸ¥: ' + stats.unknown_detected);
        }
        
        function addResult(text) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent += new Date().toLocaleTimeString() + ' - ' + text + '\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                // æª¢æŸ¥æ–‡ä»¶å¤§å°
                const fileSizeMB = file.size / (1024 * 1024);
                addResult('ğŸ“ åœ–ç‰‡æ–‡ä»¶å¤§å°: ' + fileSizeMB.toFixed(2) + ' MB');
                
                if (fileSizeMB > 5) {
                    addResult('âš ï¸ åœ–ç‰‡éå¤§ï¼Œæ­£åœ¨å£“ç¸®...');
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    if (fileSizeMB > 5) {
                        // å£“ç¸®åœ–ç‰‡
                        compressImage(e.target.result, function(compressedData) {
                            currentImageData = compressedData;
                            updateButtons(ws && ws.readyState === WebSocket.OPEN);
                            addResult('ğŸ“ åœ–ç‰‡å·²å£“ç¸®ä¸¦åŠ è¼‰: ' + file.name);
                        });
                    } else {
                        currentImageData = e.target.result;
                        updateButtons(ws && ws.readyState === WebSocket.OPEN);
                        addResult('ğŸ“ åœ–ç‰‡å·²åŠ è¼‰: ' + file.name);
                    }
                };
                reader.readAsDataURL(file);
            }
        }
        
        function compressImage(dataURL, callback) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // è¨ˆç®—æ–°å°ºå¯¸ï¼ˆæœ€å¤§ 800pxï¼‰
                let { width, height } = img;
                const maxSize = 800;
                
                if (width > height && width > maxSize) {
                    height = (height * maxSize) / width;
                    width = maxSize;
                } else if (height > maxSize) {
                    width = (width * maxSize) / height;
                    height = maxSize;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // ç¹ªè£½å£“ç¸®å¾Œçš„åœ–ç‰‡
                ctx.drawImage(img, 0, 0, width, height);
                
                // è½‰æ›ç‚º base64 (0.7 å“è³ª)
                const compressedDataURL = canvas.toDataURL('image/jpeg', 0.7);
                callback(compressedDataURL);
            };
            img.src = dataURL;
        }
        
        function sendTestImage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addResult('âŒ WebSocket æœªé€£æ¥');
                return;
            }
            
            if (!currentImageData) {
                addResult('âŒ è«‹å…ˆé¸æ“‡åœ–ç‰‡');
                return;
            }
            
            updateStatus('â³ æ­£åœ¨è™•ç†åœ–ç‰‡...', 'processing');
            
            const message = {
                type: 'video_frame',
                image: currentImageData
            };
            
            ws.send(JSON.stringify(message));
            addResult('ğŸ“¤ å·²ç™¼é€åœ–ç‰‡é€²è¡Œè­˜åˆ¥...');
        }
        
        function getStats() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addResult('âŒ WebSocket æœªé€£æ¥');
                return;
            }
            
            const message = {type: 'get_stats'};
            ws.send(JSON.stringify(message));
            addResult('ğŸ“¤ è«‹æ±‚æœå‹™çµ±è¨ˆ...');
        }
    </script>
</body>
</html>