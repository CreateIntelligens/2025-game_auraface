<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraFace çµ±ä¸€ç®¡ç†å„€è¡¨æ¿ (å–®æ©Ÿç‰ˆ)</title>
    <style>
        :root {
            --primary-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --light-gray: #f8f9fa;
            --dark-gray: #343a40; --border-color: #dee2e6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; background-color: #f4f7f9; color: #333;
            display: flex; flex-direction: column; align-items: center;
        }
        .header {
            width: 100%; background-color: var(--dark-gray); color: white;
            padding: 15px 30px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .main-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            padding: 20px; width: 100%; max-width: 1600px;
        }
        .card {
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05); display: flex; flex-direction: column;
        }
        .card-title {
            font-size: 1.5em; font-weight: 600; margin-bottom: 15px;
            border-bottom: 2px solid var(--primary-color); padding-bottom: 10px;
        }
        #realtime-container { grid-column: 1 / 2; }
        #register-container { grid-column: 2 / 3; }
        #stats-container { grid-column: 1 / 3; }
        #management-container { grid-column: 1 / 3; }
        video { 
            width: 100%; 
            height: auto; 
            border-radius: 5px; 
            background-color: #000;
            object-fit: contain; /* ç¢ºä¿å®Œæ•´é¡¯ç¤ºä¸è£åˆ‡ */
            max-height: 480px; /* é™åˆ¶æœ€å¤§é«˜åº¦ */
            transform: scaleX(-1); /* æ°´å¹³é¡åƒç¿»è½‰åƒ…å½±éŸ¿videoé¡¯ç¤º */
        }
        canvas {
            width: 100%; 
            height: auto; 
            border-radius: 5px; 
            background-color: #000;
            object-fit: contain;
            max-height: 480px;
            /* canvas ä¸ç¿»è½‰ï¼Œç›´æ¥é¡¯ç¤ºæ­£ç¢ºåº§æ¨™ */
        }
        .video-wrapper { position: relative; }
        #overlayCanvas { position: absolute; top: 0; left: 0; pointer-events: none; background: transparent; }
        button {
            padding: 10px 15px; margin: 5px; border: none; border-radius: 5px;
            cursor: pointer; font-size: 1em; transition: background-color 0.2s;
            outline: none; /* Attempt to remove unexpected white border on focus */
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: black; }
        button:hover { opacity: 0.85; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid var(--border-color); text-align: left; }
        th { background-color: var(--light-gray); font-weight: 600; }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content { background: white; padding: 30px; border-radius: 8px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; }
        input, select { width: 100%; padding: 10px; border: 1px solid var(--border-color); border-radius: 5px; font-size: 1em; }
        .modal-actions { text-align: right; margin-top: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid; }
        .status-connected { background-color: #d4edda; color: #155724; border-color: #c3e6cb; }
        .status-disconnected { background-color: #f8d7da; color: #721c24; border-color: #f5c6cb; }
    </style>
</head>
<body>

    <header class="header"><h1>AuraFace çµ±ä¸€ç®¡ç†å„€è¡¨æ¿</h1></header>

    <div class="main-container">
        <div id="realtime-container" class="card">
            <h2 class="card-title">ğŸ“¹ å³æ™‚ç›£æ§</h2>
            <div id="connectionStatus" class="status status-disconnected">æœªé€£æ¥</div>
            <div class="controls">
                <button id="connectWS" class="btn-success">é€£æ¥</button>
                <button id="startCamera" class="btn-primary">å•Ÿå‹•é¡é ­</button>
                <button id="stopCamera" class="btn-danger" disabled>åœæ­¢é¡é ­</button>
            </div>
            <div class="video-wrapper">
                <video id="videoElement" autoplay muted playsinline></video>
                <canvas id="overlayCanvas"></canvas>
            </div>
            <div id="realtimeStats" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px; min-height: 100px;">
                <div><strong>å³æ™‚è­˜åˆ¥çµæœ</strong></div>
                <div>ç­‰å¾…è­˜åˆ¥çµæœ...</div>
            </div>
            <div id="recognitionInfo" style="margin-top: 10px; padding: 10px; background: #e9ecef; border-radius: 5px; font-family: monospace; font-size: 14px;">
                ç­‰å¾…è­˜åˆ¥çµæœ...
            </div>
        </div>

        <div id="register-container" class="card">
            <h2 class="card-title">â• äººå“¡è¨»å†Š</h2>
            <div class="register-form">
                <div class="form-group"><label for="personName">å§“åï¼š</label><input type="text" id="personName"></div>
                <div class="form-group"><label for="personEmployeeId">å“¡å·¥ç·¨è™Ÿï¼š</label><input type="text" id="personEmployeeId" placeholder="é¸å¡«"></div>
                <div class="form-group"><label for="personRole">èº«åˆ†ï¼š</label><select id="personRole"><option value="å“¡å·¥">å“¡å·¥</option><option value="è¨ªå®¢">è¨ªå®¢</option></select></div>
                <div class="form-group"><label for="personDept">éƒ¨é–€ï¼š</label><input type="text" id="personDept"></div>
                <div class="form-group"><label for="personEmail">ä¿¡ç®±ï¼š</label><input type="email" id="personEmail" placeholder="é¸å¡«"></div>
                <button id="captureRegister" class="btn-success">æ‹ç…§è¨»å†Š</button>
            </div>
        </div>

        <div id="stats-container" class="card">
            <h2 class="card-title">ğŸ“Š ç³»çµ±çµ±è¨ˆ</h2>
            <div id="stats-content">ç­‰å¾…è³‡æ–™...</div>
        </div>

        <div id="management-container" class="card">
            <h2 class="card-title">ğŸ‘¥ äººå“¡è³‡æ–™ç®¡ç†</h2>
            <button id="refreshPersons" class="btn-info">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <div style="overflow-x: auto; max-height: 80vh;">
                <table id="personsTable">
                    <thead><tr><th>ID</th><th>å§“å</th><th>å“¡å·¥ç·¨è™Ÿ</th><th>èº«åˆ†</th><th>éƒ¨é–€</th><th>ä¿¡ç®±</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div id="attendance-container" class="card">
            <h2 class="card-title">ğŸ•’ å‡ºå‹¤è¨˜éŒ„</h2>
            <button id="refreshAttendance" class="btn-info">ğŸ”„ åˆ·æ–°è¨˜éŒ„</button>
            <button id="clearAttendance" class="btn-warning">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
            <div style="overflow-x: auto; max-height: 80vh;">
                <table id="attendanceTable">
                    <thead><tr><th>å§“å</th><th>ç‹€æ…‹</th><th>é¦–æ¬¡å‡ºç¾</th><th>æœ€å¾Œè¦‹åˆ°</th><th>é›¢é–‹æ™‚é–“</th><th>åœ¨å¸­æ™‚é•·</th><th>è©³ç´°è³‡è¨Š</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2 class="card-title">âœï¸ ä¿®æ”¹äººå“¡è³‡æ–™</h2>
            <input type="hidden" id="editPersonId">
            <div class="form-group"><label for="editPersonName">å§“åï¼š</label><input type="text" id="editPersonName"></div>
            <div class="form-group"><label for="editPersonEmployeeId">å“¡å·¥ç·¨è™Ÿï¼š</label><input type="text" id="editPersonEmployeeId" placeholder="é¸å¡«"></div>
            <div class="form-group"><label for="editPersonRole">èº«åˆ†ï¼š</label><select id="editPersonRole"><option value="å“¡å·¥">å“¡å·¥</option><option value="è¨ªå®¢">è¨ªå®¢</option></select></div>
            <div class="form-group"><label for="editPersonDept">éƒ¨é–€ï¼š</label><input type="text" id="editPersonDept"></div>
            <div class="form-group"><label for="editPersonEmail">ä¿¡ç®±ï¼š</label><input type="email" id="editPersonEmail" placeholder="é¸å¡«"></div>
            <div class="modal-actions">
                <button id="saveChanges" class="btn-success">å„²å­˜</button>
                <button id="closeModal" class="btn-danger">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const WS_URL = `wss://${window.location.hostname}/ws`;
        let websocket = null;
        let videoStream = null;
        let frameInterval = null;

        // DOM Elements
        const videoElement = document.getElementById('videoElement');
        const overlayCanvas = document.getElementById('overlayCanvas');
        const overlayCtx = overlayCanvas.getContext('2d');
        const connectionStatus = document.getElementById('connectionStatus');
        const personsTableBody = document.querySelector('#personsTable tbody');
        const modal = document.getElementById('editModal');

        // --- WebSocket Logic ---
        function connectWebSocket() {
            if (websocket && websocket.readyState === WebSocket.OPEN) return;
            websocket = new WebSocket(WS_URL);

            websocket.onopen = () => {
                connectionStatus.textContent = 'âœ… å·²é€£æ¥';
                connectionStatus.className = 'status status-connected';
                loadPersons(); // Auto-refresh on connect
                loadAttendance(); // Auto-refresh attendance on connect
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            websocket.onclose = () => {
                connectionStatus.textContent = 'âŒ æœªé€£æ¥';
                connectionStatus.className = 'status status-disconnected';
                // ä¸è¦è‡ªå‹•åœæ­¢ä¸²æµï¼è®“æ”åƒé ­ç¹¼çºŒé‹ä½œ
                // stopStreaming();
            };

            websocket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                connectionStatus.textContent = 'âŒ é€£æ¥éŒ¯èª¤';
                connectionStatus.className = 'status status-disconnected';
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'recognition_result':
                    updateRecognitionUI(data);
                    break;
                case 'stats':
                    updateStatsUI(data.data);
                    break;
                case 'persons_list':
                    renderPersonsTable(data.data);
                    break;
                case 'attendance_list':
                    renderAttendanceTable(data.data);
                    break;
                case 'register_result':
                case 'update_result':
                case 'delete_result':
                case 'clear_attendance_result':
                    showNotification(data.success ? `âœ… ${data.message}` : `âŒ ${data.message}`, data.success ? 'success' : 'error');
                    if (data.success) {
                        loadPersons();
                        if (data.type === 'clear_attendance_result') loadAttendance();
                    }
                    if (data.type === 'update_result') closeModal();
                    break;
                case 'person_detected':
                    handlePersonDetectedNotification(data);
                    break;
                case 'error':
                    showNotification(`ä¼ºæœå™¨éŒ¯èª¤: ${data.message}`, 'error');
                    break;
            }
        }
        
        function sendToServer(data) {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify(data));
            } else {
                showNotification('âŒ æœªé€£æ¥åˆ°ä¼ºæœå™¨', 'error');
            }
        }

        // --- UI Update Logic ---
        function updateRecognitionUI(data) {
            // æ›´æ–°ç•¶å‰äººè‡‰è³‡æ–™
            currentFaces = data.faces;
            
            // æ›´æ–°è¦†è“‹å±¤
            overlayCanvas.width = data.image_dimensions.width;
            overlayCanvas.height = data.image_dimensions.height;
            overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
            data.faces.forEach(face => {
                const [x1, y1, x2, y2] = face.bbox;
                // å¾Œç«¯è¿”å›åŸå§‹å½±åƒåº§æ¨™ï¼Œä½†ç”¨æˆ¶çœ‹åˆ°ç¿»è½‰çš„videoï¼Œéœ€è¦ç¿»è½‰åº§æ¨™åŒ¹é…
                const canvasWidth = overlayCanvas.width;
                const mirrorX1 = canvasWidth - x2;
                const mirrorX2 = canvasWidth - x1;
                
                // æ ¹æ“šä¿¡å¿ƒåº¦æ±ºå®šé¡è‰²å’Œé¡¯ç¤ºå…§å®¹
                let color, labelText;
                if (face.confidence >= 0.4) {
                    // é«˜ä¿¡å¿ƒåº¦ï¼šç¶ è‰²ï¼Œé¡¯ç¤ºå§“åå’Œè§’è‰²
                    color = face.role === 'å“¡å·¥' ? 'lime' : (face.role === 'è¨ªå®¢' ? 'yellow' : 'lime');
                    labelText = `${face.name} (${face.confidence.toFixed(2)})`;
                } else if (face.confidence >= 0.15 || face.is_uncertain) {
                    // ä¸­ç­‰ä¿¡å¿ƒåº¦ï¼šæ©˜è‰²ï¼Œåªé¡¯ç¤ºä¿¡å¿ƒåº¦
                    color = 'orange';
                    labelText = `${face.confidence.toFixed(2)}`;
                } else {
                    // ä½ä¿¡å¿ƒåº¦ï¼šç´…è‰²ï¼Œé™Œç”Ÿäºº
                    color = 'red';
                    labelText = `${face.confidence.toFixed(2)}`;
                }
                
                overlayCtx.strokeStyle = color;
                overlayCtx.lineWidth = 2;
                overlayCtx.strokeRect(mirrorX1, y1, mirrorX2 - mirrorX1, y2 - y1);
                
                // é¡¯ç¤ºæ¨™ç±¤
                overlayCtx.fillStyle = color;
                overlayCtx.font = '16px Arial';
                overlayCtx.fillText(labelText, mirrorX1, y1 > 20 ? y1 - 5 : y1 + 20);
            });

            // æ›´æ–°è­˜åˆ¥è³‡è¨Š
            const info = `
FPS: ${data.fps} | è™•ç†æ™‚é–“: ${data.processing_time}ms
æª¢æ¸¬åˆ° ${data.faces.length} å¼µäººè‡‰
${data.faces.map(face => 
    face.person_id !== 'unknown' ? `${face.name} (${face.role}) - ä¿¡å¿ƒåº¦: ${face.confidence.toFixed(3)}` : 'æœªçŸ¥äººå“¡'
).join('\n')}
æ™‚é–“: ${new Date(data.timestamp).toLocaleTimeString()}
            `;
            document.getElementById('recognitionInfo').textContent = info;
            
            // æ›´æ–°å³æ™‚çµ±è¨ˆ
            const statsHtml = `
                <div><strong>å³æ™‚è­˜åˆ¥çµæœ</strong></div>
                <div>FPS: ${data.fps}</div>
                <div>è™•ç†æ™‚é–“: ${data.processing_time}ms</div>
                <div>æª¢æ¸¬äººè‡‰: ${data.faces.length}</div>
                <div>å·²è­˜åˆ¥: ${data.faces.filter(f => f.person_id !== 'unknown').length}</div>
                <div>æœªçŸ¥: ${data.faces.filter(f => f.person_id === 'unknown').length}</div>
                <hr>
                ${data.faces.map(face => 
                    `<div style="margin: 5px 0; padding: 5px; background: ${face.person_id === 'unknown' ? '#ffebee' : '#e8f5e8'}; border-radius: 3px;">
                        ${face.person_id === 'unknown' ? 'â“ æœªçŸ¥äººå“¡' : 
                          `âœ… ${face.name}<br><small>${face.role} | ä¿¡å¿ƒåº¦: ${face.confidence.toFixed(3)}</small>`}
                    </div>`
                ).join('')}
            `;
            document.getElementById('realtimeStats').innerHTML = statsHtml;
        }

        function updateStatsUI(stats) {
            // æ›´æ–°å…¨åŸŸçµ±è¨ˆ
            updateGlobalStats(stats);
            
            const content = `
                <p><strong>ç¸½è™•ç†å¹€æ•¸:</strong> ${stats.total_frames}</p>
                <p><strong>æª¢æ¸¬åˆ°äººè‡‰:</strong> ${stats.faces_detected}</p>
                <p><strong>å“¡å·¥è­˜åˆ¥:</strong> ${stats.employees_detected}</p>
                <p><strong>æœªçŸ¥äººå“¡:</strong> ${stats.unknown_detected}</p>
            `;
            document.getElementById('stats-content').innerHTML = content;
        }

        // --- Camera and Streaming Logic ---
        async function startCamera() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: true  // ç§»é™¤å°ºå¯¸é™åˆ¶ï¼Œè®“æ”åƒé ­ä½¿ç”¨åŸç”Ÿè§£æåº¦
                });
                videoElement.srcObject = videoStream;
                
                document.getElementById('startCamera').disabled = true;
                document.getElementById('stopCamera').disabled = false;
                
                // é–‹å§‹å‚³é€å½±åƒå¹€
                startStreaming();
            } catch (error) {
                alert('ç„¡æ³•å­˜å–æ”åƒé ­: ' + error.message);
            }
        }
        
        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
                videoElement.srcObject = null;
            }
            
            document.getElementById('startCamera').disabled = false;
            document.getElementById('stopCamera').disabled = true;
            
            // åœæ­¢å‚³é€
            stopStreaming();
        }
        
        function startStreaming() {
            if (frameInterval) {
                return;
            }
            
            // æ¯ç§’å‚³é€ 5 å¹€
            frameInterval = setInterval(() => {
                if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                    sendVideoFrame();
                }
            }, 200); // 200ms = 5 FPS
        }
        
        function stopStreaming() {
            if (frameInterval) {
                clearInterval(frameInterval);
                frameInterval = null;
            }
        }
        
        function sendVideoFrame() {
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            
            const ctx = canvas.getContext('2d');
            // ç™¼é€åŸå§‹å½±åƒï¼Œä¸ç¿»è½‰
            ctx.drawImage(videoElement, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg', 0.7);
            
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({
                    type: 'video_frame',
                    image: imageData
                }));
            }
        }

        // --- Person Management Logic ---
        function loadPersons() { sendToServer({ type: 'get_persons' }); }

        function renderPersonsTable(persons) {
            personsTableBody.innerHTML = '';
            if (!persons || persons.length === 0) {
                personsTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">æ²’æœ‰è³‡æ–™</td></tr>';
                return;
            }
            persons.forEach(p => {
                const row = personsTableBody.insertRow();
                row.innerHTML = `
                    <td>${p.person_id}</td><td>${p.name}</td><td>${p.employee_id || 'N/A'}</td><td>${p.role}</td><td>${p.department || 'N/A'}</td><td>${p.email || 'N/A'}</td>
                    <td>
                        <button class="btn-warning btn-sm" onclick="openEditModal('${p.person_id}', '${p.name}', '${p.employee_id || ''}', '${p.role}', '${p.department || ''}', '${p.email || ''}')">ä¿®æ”¹</button>
                        <button class="btn-danger btn-sm" onclick="deletePerson('${p.person_id}', '${p.name}')">åˆªé™¤</button>
                    </td>`;
            });
        }

        function deletePerson(id, name) {
            if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€(${id}) å—ï¼Ÿ`)) {
                sendToServer({ type: 'delete_person', person_id: id });
            }
        }

        // --- Modal Logic ---
        const personIdInput = document.getElementById('editPersonId');
        const personNameInput = document.getElementById('editPersonName');
        const personEmployeeIdInput = document.getElementById('editPersonEmployeeId');
        const personRoleInput = document.getElementById('editPersonRole');
        const personDeptInput = document.getElementById('editPersonDept');
        const personEmailInput = document.getElementById('editPersonEmail');

        function openEditModal(id, name, employee_id, role, dept, email) {
            personIdInput.value = id;
            personNameInput.value = name;
            personEmployeeIdInput.value = employee_id || '';
            personRoleInput.value = role;
            personDeptInput.value = dept;
            personEmailInput.value = email || '';
            modal.style.display = 'flex';
        }

        function closeModal() { modal.style.display = 'none'; }

        function saveChanges() {
            sendToServer({
                type: 'update_person',
                person_id: personIdInput.value,
                name: personNameInput.value,
                employee_id: personEmployeeIdInput.value,
                role: personRoleInput.value,
                department: personDeptInput.value,
                email: personEmailInput.value
            });
        }
        
        function captureForRegistration() {
            const name = document.getElementById('personName').value.trim();
            if (!name) { return showNotification('è«‹è¼¸å…¥å§“å', 'error'); }
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            // è¨»å†Šæ™‚ä¹Ÿä¸ç¿»è½‰ï¼Œç™¼é€åŸå§‹å½±åƒ
            ctx.drawImage(videoElement, 0, 0);
            const imageData = canvas.toDataURL('image/jpeg', 0.9);
            sendToServer({
                type: 'register_face',
                name: name,
                employee_id: document.getElementById('personEmployeeId').value.trim(),
                role: document.getElementById('personRole').value,
                department: document.getElementById('personDept').value.trim(),
                email: document.getElementById('personEmail').value.trim(),
                image: imageData
            });
        }

        // --- Person Detection Notification ---
        function handlePersonDetectedNotification(data) {
            const isFirstDetection = data.first_detection;
            const notificationCount = data.notification_count;
            
            // æ ¹æ“šèº«åˆ†é¸æ“‡é¡è‰²å’Œåœ–ç¤º
            let color, icon;
            if (data.role === 'å“¡å·¥') {
                color = 'var(--success-color)';
                icon = 'ğŸ‘¨â€ğŸ’¼';
            } else if (data.role === 'è¨ªå®¢') {
                color = 'var(--warning-color)';
                icon = 'ğŸ‘¤';
            } else {
                color = 'var(--info-color)';
                icon = 'ğŸ”';
            }
            
            // å»ºç«‹é€šçŸ¥è¨Šæ¯
            let message;
            if (isFirstDetection) {
                message = `${icon} æª¢æ¸¬åˆ° ${data.name} (${data.role})`;
            } else {
                message = `${icon} ${data.name} ä»åœ¨ç¾å ´ (ç¬¬${notificationCount}æ¬¡é€šçŸ¥)`;
            }
            
            // é¡¯ç¤ºé€šçŸ¥
            showPersonDetectedNotification(message, color, data);
            
            // Console æ—¥èªŒï¼ˆå­¸ç¿’ sdk-demo é¢¨æ ¼ï¼‰
            console.log(`ğŸ‘¤ äººå“¡æª¢æ¸¬é€šçŸ¥: ${data.name} (${data.role})`);
            console.log(`    éƒ¨é–€: ${data.department || 'æœªè¨­å®š'}`);
            console.log(`    ä¿¡å¿ƒåº¦: ${data.confidence.toFixed(4)}`);
            console.log(`    æ™‚é–“: ${data.timestamp}`);
            console.log(`    ${isFirstDetection ? 'é¦–æ¬¡æª¢æ¸¬' : `ç¬¬${notificationCount}æ¬¡é€šçŸ¥`}`);
        }
        
        function showPersonDetectedNotification(message, color, data) {
            const el = document.createElement('div');
            el.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">${message}</div>
                <div style="font-size: 0.9em; opacity: 0.9;">
                    éƒ¨é–€: ${data.department || 'æœªè¨­å®š'} | ä¿¡å¿ƒåº¦: ${data.confidence.toFixed(3)}
                </div>
                <div style="font-size: 0.8em; opacity: 0.8; margin-top: 3px;">
                    ${data.timestamp}
                </div>
            `;
            el.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                background-color: ${color};
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 2000;
                transition: all 0.5s ease;
                max-width: 350px;
                border-left: 4px solid rgba(255,255,255,0.5);
            `;
            
            document.body.appendChild(el);
            
            // å‹•ç•«æ•ˆæœ
            setTimeout(() => {
                el.style.transform = 'translateX(-10px)';
            }, 100);
            
            // è‡ªå‹•æ¶ˆå¤±
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateX(100%)';
                setTimeout(() => el.remove(), 500);
            }, 5000); // 5ç§’å¾Œæ¶ˆå¤±
        }

        // --- Utility ---
        function showNotification(message, type) {
            const el = document.createElement('div');
            el.textContent = message;
            el.style.cssText = `position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:8px;color:white;background-color:${type === 'success' ? 'var(--success-color)' : 'var(--danger-color)'};box-shadow:0 4px 8px rgba(0,0,0,0.2);z-index:2000;transition:opacity 0.5s;`;
            document.body.appendChild(el);
            setTimeout(() => { el.style.opacity = '0'; setTimeout(() => el.remove(), 500); }, 3000);
        }

        // å®šæœŸè«‹æ±‚çµ±è¨ˆè³‡æ–™
        function requestStats() {
            if (websocket && websocket.readyState === WebSocket.OPEN) {
                websocket.send(JSON.stringify({ type: 'get_stats' }));
            }
        }

        // å…¨åŸŸçµ±è¨ˆè³‡æ–™
        let globalStats = { total_frames: 0, faces_detected: 0, employees_detected: 0, unknown_detected: 0 };
        let currentFaces = [];

        // æ›´æ–°å…¨åŸŸçµ±è¨ˆ
        function updateGlobalStats(stats) {
            globalStats = stats;
        }

        // ç®¡ç†å“¡å°ˆç”¨å¿«æ·éµï¼ˆå­¸ç¿’ sdk-demoï¼‰
        document.addEventListener('keydown', function(event) {
            if (event.ctrlKey) {
                switch(event.key) {
                    case 'r':
                        // Ctrl+R: é‡æ–°é€£æ¥
                        event.preventDefault();
                        if (websocket) websocket.close();
                        setTimeout(() => connectWebSocket(), 1000);
                        console.log('ğŸ”„ é‡æ–°é€£æ¥ä¸­...');
                        break;
                    case 's':
                        // Ctrl+S: ç²å–çµ±è¨ˆè³‡æ–™
                        event.preventDefault();
                        console.log('ğŸ“Š çµ±è¨ˆè³‡æ–™:', globalStats);
                        break;
                    case 'f':
                        // Ctrl+F: ç²å–ç•¶å‰äººè‡‰è©³ç´°è³‡è¨Š
                        event.preventDefault();
                        if (currentFaces.length > 0) {
                            console.table(currentFaces.map(face => ({
                                å§“å: face.name || 'æœªçŸ¥',
                                èº«åˆ†: face.role || 'æœªçŸ¥',
                                éƒ¨é–€: face.department || 'æœªè¨­å®š',
                                ä¿¡å¿ƒåº¦: face.confidence ? face.confidence.toFixed(4) : 'N/A',
                                äººè‡‰ID: face.person_id
                            })));
                        } else {
                            console.log('ç›®å‰æ²’æœ‰æª¢æ¸¬åˆ°äººè‡‰');
                        }
                        break;
                }
            }
        });

        // --- Attendance Management Logic ---
        function loadAttendance() { 
            sendToServer({ type: 'get_attendance' }); 
        }

        function renderAttendanceTable(records) {
            const attendanceTableBody = document.querySelector('#attendanceTable tbody');
            attendanceTableBody.innerHTML = '';
            if (!records || records.length === 0) {
                attendanceTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">æ²’æœ‰å‡ºå‹¤è¨˜éŒ„</td></tr>';
                return;
            }
            records.forEach(record => {
                const row = attendanceTableBody.insertRow();
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td><span style="color: ${record.status === 'æ´»èº' ? 'green' : 'gray'}">${record.status}</span></td>
                    <td><small>${record.arrival_time}</small></td>
                    <td><small>${record.last_seen_time || 'ç„¡'}</small></td>
                    <td><small>${record.departure_time}</small></td>
                    <td>${record.duration}</td>
                    <td><small>ID: ${record.person_id || 'ç„¡'}<br>éƒ¨é–€: ${record.department || 'æœªè¨­å®š'}</small></td>
                `;
            });
        }

        function clearAttendance() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å‡ºå‹¤è¨˜éŒ„å—ï¼Ÿ')) {
                sendToServer({ type: 'clear_attendance' });
            }
        }

        // --- Event Listeners ---
        document.getElementById('connectWS').addEventListener('click', connectWebSocket);
        document.getElementById('startCamera').addEventListener('click', startCamera);
        document.getElementById('stopCamera').addEventListener('click', stopCamera);
        document.getElementById('captureRegister').addEventListener('click', captureForRegistration);
        document.getElementById('refreshPersons').addEventListener('click', loadPersons);
        document.getElementById('refreshAttendance').addEventListener('click', loadAttendance);
        document.getElementById('clearAttendance').addEventListener('click', clearAttendance);
        document.getElementById('saveChanges').addEventListener('click', saveChanges);
        document.getElementById('closeModal').addEventListener('click', closeModal);
        window.addEventListener('load', connectWebSocket);
        
        // å®šæœŸæ›´æ–°çµ±è¨ˆ
        setInterval(requestStats, 5000); // æ¯ 5 ç§’æ›´æ–°çµ±è¨ˆ

        // ç®¡ç†å“¡å„€è¡¨æ¿è³‡è¨Šï¼ˆå­¸ç¿’ sdk-demoï¼‰
        console.log(`
ğŸ”§ AuraFace ç®¡ç†ç³»çµ±å¿«æ·éµï¼š
- Ctrl+Rï¼šé‡æ–°é€£æ¥ä¼ºæœå™¨
- Ctrl+Sï¼šæŸ¥çœ‹çµ±è¨ˆè³‡æ–™
- Ctrl+Fï¼šæŸ¥çœ‹ç•¶å‰äººè‡‰è©³ç´°è³‡è¨Š

ğŸ“Š ç®¡ç†åŠŸèƒ½ï¼š
- äººè‡‰è¨»å†Šï¼šæ”¯æ´å³æ™‚è¨»å†Š
- å³æ™‚çµ±è¨ˆï¼šç´¯è¨ˆè­˜åˆ¥æ•¸æ“š
- äººå“¡ç®¡ç†ï¼šå®Œæ•´ CRUD æ“ä½œ
- è©³ç´°æ—¥èªŒï¼šå®Œæ•´çš„æ“ä½œè¨˜éŒ„
        `);

        // å®šæœŸé¡¯ç¤ºç³»çµ±ç‹€æ…‹ï¼ˆåƒ…é–‹ç™¼æ™‚ä½¿ç”¨ï¼‰
        if (location.hostname === 'localhost') {
            setInterval(() => {
                const status = websocket ? (websocket.readyState === WebSocket.OPEN ? 'å·²é€£æ¥' : 'æœªé€£æ¥') : 'æœªé€£æ¥';
                console.log(`[${new Date().toLocaleTimeString()}] ç‹€æ…‹: ${status}, ç•¶å‰äººè‡‰: ${currentFaces.length}, ç¸½è™•ç†å¹€æ•¸: ${globalStats.total_frames}`);
            }, 30000); // æ¯30ç§’
        }
    </script>
</body>
</html>
